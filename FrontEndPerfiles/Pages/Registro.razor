@page "/registro"
@using FrontEndPerfiles.Models
@using FrontEndPerfiles.Services
@inject AuthService AuthService
@inject NavigationManager Navigation

<PageTitle>Registro</PageTitle>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h3>Registro de Usuario</h3>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-danger">@errorMessage</div>
                    }

                    <EditForm Model="@perfil" OnValidSubmit="@HandleRegistro">
                        <DataAnnotationsValidator />

                        <div class="mb-3">
                            <label class="form-label">Nombre</label>
                            <InputText class="form-control" @bind-Value="perfil.Nombre" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <InputText type="email" class="form-control" @bind-Value="perfil.Email" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Contraseña</label>
                            <InputText type="password" class="form-control" @bind-Value="perfil.Password" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Teléfono</label>
                            <InputText class="form-control" @bind-Value="perfil.Telefono" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Dirección</label>
                            <InputText class="form-control" @bind-Value="perfil.Direccion" />
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Foto de Perfil</label>
                            <InputFile class="form-control" OnChange="@HandleFileSelected" accept="image/*" />
                            @if (!string.IsNullOrEmpty(perfil.Foto))
                            {
                                <div class="mt-2">
                                    <img src="@perfil.Foto" alt="Preview" style="max-width: 200px; max-height: 200px;" />
                                </div>
                            }
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary" disabled="@isProcessing">
                                @if (isProcessing)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                Registrarse
                            </button>
                        </div>
                    </EditForm>

                    <div class="mt-3 text-center">
                        <a href="/login">¿Ya tienes cuenta? Inicia sesión</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private Perfil perfil = new Perfil();
    private string errorMessage = string.Empty;
    private bool isProcessing = false;

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            try
            {
                var buffer = new byte[file.Size];
                await file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024).ReadAsync(buffer);
                var base64 = Convert.ToBase64String(buffer);
                perfil.Foto = $"data:{file.ContentType};base64,{base64}";
            }
            catch (Exception ex)
            {
                errorMessage = $"Error al cargar la imagen: {ex.Message}";
            }
        }
    }

    private async Task HandleRegistro()
    {
        isProcessing = true;
        errorMessage = string.Empty;

        try
        {
            var result = await AuthService.RegisterAsync(perfil);
            if (result != null)
            {
                Navigation.NavigateTo("/login");
            }
            else
            {
                errorMessage = "Error al registrar el usuario. El email puede estar en uso.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }
}
